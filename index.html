<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Viaje de Rol v15</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
        }
        .map-bg {
            background-image: url('https://github.com/acuadross/mapgame/blob/main/map.jpg?raw=true');
            background-size: cover;
            background-position: center;
        }
        .loading-dots span {
            animation: blink 1.4s infinite both;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .btn-action {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-sky-100 text-slate-800 flex items-center justify-center min-h-screen p-4 map-bg">

    <div class="max-w-3xl w-full bg-white/85 backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 border-o border-sky-500">
        
        <header class="text-center mb-6">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-sky-700">Configuraci√≥n de la Partida</h1>
            <p id="subtitle" class="text-slate-600 mt-2">¬øQui√©nes se unen a la aventura?</p>
        </header>

        <main id="main-content">
            <!-- Pantalla de Configuraci√≥n Inicial -->
            <div id="setup-section">
                <div class="mb-6">
                    <label for="player-count" class="block mb-2 font-semibold text-lg text-slate-700">N√∫mero de jugadores:</label>
                    <input type="number" id="player-count" min="1" max="8" value="2" class="w-full p-3 rounded-lg border-2 border-slate-300 focus:border-sky-500 focus:ring-sky-500">
                </div>
                <div id="player-names-container" class="space-y-4"></div>
                <div class="mt-8 text-center">
                    <button id="start-game-btn" class="bg-green-500/80 text-white font-bold py-3 px-8 rounded-full hover:bg-green-500/90 transform hover:scale-105 transition-transform duration-300 shadow-lg text-xl" disabled>
                        Cargando datos...
                    </button>
                </div>
            </div>

            <!-- Pantalla de Juego Principal -->
            <div id="game-section" class="hidden">
                 <div id="global-info-bar" class="flex justify-between items-center mb-4 bg-amber-100/70 p-3 rounded-lg">
                     <div id="player-status-bar" class="text-sm text-slate-700 flex-wrap"></div>
                     <div id="treasure-tracker" class="text-sm font-semibold text-amber-800 cursor-pointer">Tesoros: 0 / 5</div>
                 </div>

                <div id="game-view">
                    <!-- Aqu√≠ se renderizar√° el contenido din√°mico del juego -->
                </div>

                <div class="mt-6 flex justify-between items-center">
                     <button id="gm-toggle-btn" class="bg-gray-600 text-white font-bold py-1 px-3 rounded-md hover:bg-gray-700 transition-colors text-xs">üëÅÔ∏è Ver Secretos</button>
                     <button id="restart-game-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-full hover:bg-red-600 transition-colors text-sm">Reiniciar Partida</button>
                </div>

                <div id="gm-panel" class="hidden mt-4 bg-gray-800 text-white p-4 rounded-lg text-xs">
                    <h3 class="font-bold text-center mb-2 text-base">Panel del Game Master</h3>
                    <div id="gm-info" class="grid grid-cols-2 gap-x-4 gap-y-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- BASE DE DATOS DEL JUEGO ---
        const gameDatabase = []; // Se llenar√° din√°micamente al cargar

        // --- ESTADO DEL JUEGO ---
        let players = [];
        let currentPlayerIndex = 0;
        let gameMasterData = {};
        let gameState = {};

        // --- ELEMENTOS DEL DOM ---
        const mainTitle = document.getElementById('main-title');
        const subtitle = document.getElementById('subtitle');
        const setupSection = document.getElementById('setup-section');
        const gameSection = document.getElementById('game-section');
        const playerCountInput = document.getElementById('player-count');
        const playerNamesContainer = document.getElementById('player-names-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameView = document.getElementById('game-view');
        const playerStatusBar = document.getElementById('player-status-bar');
        const treasureTracker = document.getElementById('treasure-tracker');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const gmToggleBtn = document.getElementById('gm-toggle-btn');
        const gmPanel = document.getElementById('gm-panel');
        const gmInfo = document.getElementById('gm-info');

        // --- FUNCIONES DE UTILIDAD ---
        const shuffle = (array) => [...array].sort(() => 0.5 - Math.random());
        const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 0.5 - Math.cos(dLat) / 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * (1 - Math.cos(dLon)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        };

        // --- L√ìGICA DE CONFIGURACI√ìN DEL JUEGO ---
        function setupNewGame() {
            gameMasterData = { monsters: {}, ports: {}, treasures: {} };
            gameState = {
                treasuresCollected: [],
                currentCombat: null,
                currentSeaVoyage: null,
                triviaState: {} // Para rastrear preguntas y pistas usadas
            };
            const continents = ["Europa", "Asia", "Am√©rica", "√Åfrica", "Ocean√≠a"];

            for (const continent of continents) {
                const countriesInContinent = shuffle(gameDatabase.filter(c => c.continent === continent));
                const usedCountryNames = new Set();

                // Find candidates
                const monsterCandidates = countriesInContinent.filter(c => c.Monstruos.length > 0);
                const treasureCandidates = countriesInContinent.filter(c => c.Tesoros.length > 0);
                const portCandidates = countriesInContinent.filter(c => c.coastal);

                // Assign Monster
                if (monsterCandidates.length > 0) {
                    const monsterCountry = monsterCandidates[0];
                    const monsterName = getRandomElement(monsterCountry.Monstruos);
                    gameMasterData.monsters[monsterCountry.name] = { continent, hp: getRandomElement([10, 15, 20]), name: monsterName };
                    usedCountryNames.add(monsterCountry.name);
                }

                // Assign Treasure from candidates not already used
                const availableTreasureCandidates = treasureCandidates.filter(c => !usedCountryNames.has(c.name));
                if (availableTreasureCandidates.length > 0) {
                    const treasureCountry = availableTreasureCandidates[0];
                    const treasureName = getRandomElement(treasureCountry.Tesoros);
                    gameMasterData.treasures[treasureCountry.name] = { continent, found: false, name: treasureName };
                    usedCountryNames.add(treasureCountry.name);
                }

                // Assign Ports from candidates not already used
                const availablePortCandidates = portCandidates.filter(c => !usedCountryNames.has(c.name));
                if (availablePortCandidates.length > 0) {
                    const portsToAssign = availablePortCandidates.slice(0, 2);
                    portsToAssign.forEach(country => {
                        gameMasterData.ports[country.name] = { continent };
                        usedCountryNames.add(country.name);
                    });
                }
            }
            displayGmInfo();
        }

        function displayGmInfo() {
            const continents = ["Europa", "Asia", "Am√©rica", "√Åfrica", "Ocean√≠a"];
            let html = '';
            continents.forEach(c => {
                 html += `<div class="font-bold col-span-2 underline mt-2">${c}</div>`;
                 const monsterEntry = Object.entries(gameMasterData.monsters).find(([_, v]) => v.continent === c);
                 const treasureEntry = Object.entries(gameMasterData.treasures).find(([_, v]) => v.continent === c);
                 const ports = Object.keys(gameMasterData.ports).filter(k => gameMasterData.ports[k].continent === c);
                 
                 if(monsterEntry) html += `<div>üëπ ${monsterEntry[1].name}:</div><div>${monsterEntry[0]}</div>`;
                 if(treasureEntry) html += `<div>üíé ${treasureEntry[1].name}:</div><div>${treasureEntry[0]}</div>`;
                 if(ports.length > 0) html += `<div>‚öì Puertos:</div><div>${ports.join(', ')}</div>`;
            });
            gmInfo.innerHTML = html;
        }

        function generatePlayerNameInputs() {
            const count = parseInt(playerCountInput.value, 10);
            playerNamesContainer.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                playerNamesContainer.innerHTML += `
                    <div class="flex flex-col">
                        <label for="player-${i}-name" class="mb-1 font-medium text-slate-600">Nombre del Jugador ${i}:</label>
                        <input type="text" id="player-${i}-name" class="player-name-input w-full p-2 rounded-lg border-2 border-slate-300" placeholder="Aventurero ${i}">
                    </div>`;
            }
        }
        
        // --- RENDERIZADO DE VISTAS DE JUEGO ---
        function renderView(html) { gameView.innerHTML = html; }

        function renderTurnView() {
            const currentPlayer = players[currentPlayerIndex];
            renderView(`
                <div id="input-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                        <div class="flex flex-col">
                            <label class="mb-2 font-semibold text-lg text-slate-700">üìç Sales desde:</label>
                            <input value="${currentPlayer.currentCountry}" readonly class="w-full p-3 rounded-lg border-2 border-slate-300 bg-slate-200 cursor-not-allowed">
                        </div>
                        <div class="flex flex-col">
                            <label for="diceInput" class="mb-2 font-semibold text-lg text-slate-700">üé≤ ¬øQu√© has sacado?</label>
                            <input type="number" id="diceInput" min="2" max="12" placeholder="Ej: 7" class="w-full p-3 rounded-lg border-2 border-slate-300 focus:border-sky-500 focus:ring-sky-500">
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <button id="searchButton" class="bg-orange-500/80 text-white font-bold py-3 px-8 rounded-full hover:bg-orange-500/90 transform hover:scale-105 transition-transform duration-300 shadow-lg text-xl">
                            üó∫Ô∏è ¬°Buscar Destinos!
                        </button>
                    </div>
                </div>
                <div id="results-container" class="mt-10"></div>`);
            document.getElementById('searchButton').addEventListener('click', findReachableCountries);
            const diceInput = document.getElementById('diceInput');
            diceInput.addEventListener('keyup', e => e.key === 'Enter' && findReachableCountries());
            diceInput.focus();
        }

        // --- L√ìGICA DEL JUEGO PRINCIPAL ---
        function updateUI() {
            if (players.length === 0) return;
            const currentPlayer = players[currentPlayerIndex];
            mainTitle.textContent = `Turno de ${currentPlayer.name}`;
            subtitle.textContent = `¬°A la aventura!`;
            playerStatusBar.innerHTML = players.map(p => `<strong>${p.name}</strong> (${p.hp > 0 ? p.hp + '‚ù§Ô∏è' : '‚ò†Ô∏è'}) en ${p.currentCountry}`).join(' | ');
            treasureTracker.textContent = `Tesoros: ${gameState.treasuresCollected.length} / 5`;
            
            if (gameState.currentSeaVoyage && gameState.currentSeaVoyage.playerIndex === currentPlayerIndex) {
                 renderSeaVoyageView();
            } else if (gameState.currentCombat && players[currentPlayerIndex].currentCountry === gameState.currentCombat.country) {
                renderCombatView();
            } else {
                 renderTurnView();
            }
        }
        
        function checkCountryForEvent(countryName) {
            const hasMonster = gameMasterData.monsters[countryName] && !gameMasterData.monsters[countryName].defeated;
            const hasPort = gameMasterData.ports[countryName];
            const hasTreasure = gameMasterData.treasures[countryName] && !gameMasterData.treasures[countryName].found;

            if (hasMonster) {
                startCombat(countryName);
            } else if (hasPort) {
                offerPortTravel(countryName);
            } else {
                if (hasTreasure) {
                    startTreasureQuest(countryName);
                } else {
                    startTrivia(countryName, true, null); // Trivia para pista
                }
            }
        }
        
        function findReachableCountries() {
            const diceInput = document.getElementById('diceInput');
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';
            document.getElementById('searchButton').disabled = true;

            const startCountryName = players[currentPlayerIndex].currentCountry;
            const diceRoll = parseInt(diceInput.value, 10);

            if (isNaN(diceRoll) || diceRoll < 2 || diceRoll > 12) {
                resultsContainer.innerHTML = `<p class="text-center text-red-600">Por favor, introduce un n√∫mero v√°lido de los dados (entre 2 y 12).</p>`;
                document.getElementById('searchButton').disabled = false;
                return;
            }

            const startCountry = gameDatabase.find(c => c.name === startCountryName);
            if (!startCountry) {
                 console.error("Error: Pa√≠s de inicio no encontrado en la base de datos:", startCountryName);
                 resultsContainer.innerHTML = `<p class="text-center text-red-600">Error: no se encuentran datos para ${startCountryName}.</p>`;
                 document.getElementById('searchButton').disabled = false;
                 return;
            }

            let minRollRequired;
            let numCountries = 0;
            const area = startCountry.area;

            if (area <= 20000) {
                minRollRequired = 2;
                if (diceRoll >= minRollRequired) {
                    numCountries = diceRoll;
                }
            } else if (area <= 100000) {
                minRollRequired = 3;
            } else if (area <= 500000) {
                minRollRequired = 4;
            } else if (area <= 1000000) {
                minRollRequired = 5;
            } else if (area <= 4000000) {
                minRollRequired = 7;
            } else {
                minRollRequired = 9;
            }
            
            if (area > 20000 && diceRoll >= minRollRequired) {
                 numCountries = diceRoll - minRollRequired + 1;
            }

            if (diceRoll < minRollRequired) {
                const excuse = getRandomElement(startCountry.Excusas) || "la mala suerte te impide salir.";
                resultsContainer.innerHTML = `<p class="text-center text-red-600 p-4 bg-red-100 rounded-lg">No puedes salir del pa√≠s porque ${excuse}</p><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-6 rounded-full">Terminar Turno</button>`;
                document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
                document.getElementById('searchButton').disabled = false;
                return;
            }
            
            const reachable = gameDatabase
                .filter(c => c.name !== startCountryName)
                .map(c => ({ ...c, distance: getDistance(startCountry.lat, startCountry.lon, c.lat, c.lon) }))
                .sort((a, b) => a.distance - b.distance)
                .slice(0, numCountries);

            if (reachable.length === 0) {
                 resultsContainer.innerHTML = `<p class="text-center text-slate-700">No hay pa√≠ses a tu alcance. ¬°Qu√© mala suerte!</p><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-6 rounded-full">Terminar Turno</button>`;
                 document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
            } else {
                 displayResults(reachable);
            }
            document.getElementById('searchButton').disabled = false;
        }

        function displayResults(countries) {
            const resultsContainer = document.getElementById('results-container');
            let listHtml = `<h2 class="text-2xl font-bold text-sky-600 mb-4 text-center">Elige tu destino:</h2><ul class="space-y-3">`;
            countries.forEach(country => {
                listHtml += `
                    <li class="bg-white/80 p-4 rounded-lg shadow flex justify-between items-center border border-slate-200 hover:bg-sky-100 cursor-pointer transition-colors duration-200" data-country-name="${country.name}">
                        <span class="font-semibold text-slate-700 text-lg">${country.name}</span>
                        <span class="text-sm bg-sky-200 text-sky-800 font-medium py-1 px-3 rounded-full">${Math.round(country.distance).toLocaleString('es-ES')} km</span>
                    </li>`;
            });
            listHtml += '</ul>';
            resultsContainer.innerHTML = listHtml;
            resultsContainer.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', (e) => {
                    const countryName = e.currentTarget.dataset.countryName;
                    players[currentPlayerIndex].currentCountry = countryName;
                    updateUI();
                    checkCountryForEvent(countryName);
                });
            });
        }
        
        function startTrivia(countryName, forClue = false, onCorrectCallback = null) {
            const countryData = gameDatabase.find(c => c.name === countryName);
            if (!countryData || countryData.Preguntas.length === 0) {
                renderView(`<div class="text-center p-4">No hay nada interesante que preguntar aqu√≠. <br><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Continuar</button></div>`);
                document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
                return;
            }

            if (!gameState.triviaState[countryName]) {
                gameState.triviaState[countryName] = { usedQuestions: [] };
            }

            const availableQuestions = countryData.Preguntas.map((q, i) => i)
                .filter(i => !gameState.triviaState[countryName].usedQuestions.includes(i));
            
            if (availableQuestions.length === 0) {
                renderView(`<div class="text-center p-4">Ya has respondido a todo lo que sab√≠amos sobre ${countryName}.<br><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Continuar</button></div>`);
                document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
                return;
            }

            const questionIndex = getRandomElement(availableQuestions);
            gameState.triviaState[countryName].usedQuestions.push(questionIndex);

            const question = countryData.Preguntas[questionIndex];
            const correctAnswer = countryData.Respuesta1[questionIndex];
            const answers = shuffle([
                correctAnswer,
                countryData.Respuesta2[questionIndex],
                countryData.Respuesta3[questionIndex]
            ]);

            let triviaHtml = `<div class="text-center">
                <p class="text-2xl font-semibold text-slate-800 mb-6">${question}</p>
                <div class="grid grid-cols-1 gap-4">`;
            answers.forEach((answer) => {
                triviaHtml += `<button class="trivia-answer-btn w-full bg-sky-500 text-white font-bold p-4 rounded-lg shadow-md hover:bg-sky-600">${answer}</button>`;
            });
            triviaHtml += `</div><div id="trivia-feedback" class="mt-4"></div></div>`;
            renderView(triviaHtml);

            document.querySelectorAll('.trivia-answer-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const selectedAnswer = e.target.textContent;
                    const isCorrect = selectedAnswer === correctAnswer;
                    const feedbackDiv = document.getElementById('trivia-feedback');
                    document.querySelectorAll('.trivia-answer-btn').forEach(b => b.disabled = true);

                    if (isCorrect) {
                        e.target.classList.replace('bg-sky-500', 'bg-green-500');
                        if (onCorrectCallback) {
                            feedbackDiv.innerHTML = `<p class="text-green-700 font-bold text-xl">¬°Correcto!</p>`;
                            setTimeout(onCorrectCallback, 1500);
                        } else if (forClue) {
                            feedbackDiv.innerHTML = `<p class="text-green-700 font-bold text-xl">¬°Correcto! Has ganado una pista...</p>`;
                            setTimeout(() => generateTreasureClue(countryName), 1500);
                        } else {
                            feedbackDiv.innerHTML = `<p class="text-green-700 font-bold text-xl">¬°Correcto!</p>`;
                            setTimeout(nextTurn, 1500);
                        }
                    } else {
                        e.target.classList.replace('bg-sky-500', 'bg-red-500');
                        feedbackDiv.innerHTML = `<p class="text-red-700 font-bold text-xl">¬°Casi! Sigue buscando.</p>`;
                        setTimeout(nextTurn, 1500);
                    }
                });
            });
        }
        
        function nextTurn() {
            const alivePlayers = players.filter(p => p.hp > 0);
            if (alivePlayers.length === 0) {
                renderView(`<div class="text-center font-bold text-2xl text-red-600">¬°Todos los jugadores han sido derrotados!</div>`);
                return;
            }
            if (gameState.treasuresCollected.length >= 5) {
                 renderView(`<div class="text-center font-bold text-2xl text-green-600">¬°Felicidades! ¬°Hab√©is encontrado todos los tesoros!</div>`);
                return;
            }

            let nextPlayerIndex = (currentPlayerIndex + 1) % players.length;
            while (players[nextPlayerIndex].hp <= 0) {
                nextPlayerIndex = (nextPlayerIndex + 1) % players.length;
            }
            currentPlayerIndex = nextPlayerIndex;

            if (gameState.currentCombat && players[currentPlayerIndex].currentCountry !== gameState.currentCombat.country) {
                gameState.currentCombat = null;
            }

            updateUI();
        }

        // --- INICIALIZACI√ìN ---
        async function loadGameData() {
            try {
                const response = await fetch('game_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const richData = await response.json();
                initializeDatabase(richData);
                startGameBtn.disabled = false;
                startGameBtn.textContent = 'üåç ¬°Comenzar Aventura!';
            } catch (error) {
                console.error("Could not load game database:", error);
                mainTitle.textContent = "Error al Cargar Datos";
                subtitle.textContent = "Por favor, refresca la p√°gina o contacta al administrador.";
                startGameBtn.textContent = 'Error de Carga';
                startGameBtn.classList.replace('bg-green-500/80', 'bg-red-500/80');
            }
        }

        function initializeDatabase(richData) {
            const allCountriesData = [
                 { name: "Afganist√°n", lat: 33.93911, lon: 67.709953, area: 652230, continent: "Asia", coastal: false }, { name: "Albania", lat: 41.153332, lon: 20.168331, area: 28748, continent: "Europa", coastal: true }, { name: "Alemania", lat: 51.165691, lon: 10.451526, area: 357022, continent: "Europa", coastal: true }, { name: "Andorra", lat: 42.546245, lon: 1.601554, area: 468, continent: "Europa", coastal: false }, { name: "Angola", lat: -11.202692, lon: 17.873887, area: 1246700, continent: "√Åfrica", coastal: true }, { name: "Antigua y Barbuda", lat: 17.060816, lon: -61.796428, area: 442, continent: "Am√©rica", coastal: true }, { name: "Arabia Saudita", lat: 23.885942, lon: 45.079162, area: 2149690, continent: "Asia", coastal: true }, { name: "Argelia", lat: 28.033886, lon: 1.659626, area: 2381741, continent: "√Åfrica", coastal: true }, { name: "Argentina", lat: -38.416097, lon: -63.616672, area: 2780400, continent: "Am√©rica", coastal: true }, { name: "Armenia", lat: 40.069099, lon: 45.038189, area: 29743, continent: "Asia", coastal: false }, { name: "Australia", lat: -25.274398, lon: 133.775136, area: 7692024, continent: "Ocean√≠a", coastal: true }, { name: "Austria", lat: 47.516231, lon: 14.550072, area: 83871, continent: "Europa", coastal: false }, { name: "Azerbaiy√°n", lat: 40.143105, lon: 47.576927, area: 86600, continent: "Asia", coastal: true }, { name: "Bahamas", lat: 25.03428, lon: -77.39628, area: 13943, continent: "Am√©rica", coastal: true }, { name: "Banglad√©s", lat: 23.684994, lon: 90.356331, area: 147570, continent: "Asia", coastal: true }, { name: "Barbados", lat: 13.193887, lon: -59.543198, area: 430, continent: "Am√©rica", coastal: true }, { name: "Bar√©in", lat: 25.930414, lon: 50.637772, area: 765, continent: "Asia", coastal: true }, { name: "B√©lgica", lat: 50.503887, lon: 4.469936, area: 30528, continent: "Europa", coastal: true }, { name: "Belice", lat: 17.189877, lon: -88.49765, area: 22966, continent: "Am√©rica", coastal: true }, { name: "Ben√≠n", lat: 9.30769, lon: 2.315834, area: 112622, continent: "√Åfrica", coastal: true }, { name: "Bielorrusia", lat: 53.709807, lon: 27.953389, area: 207600, continent: "Europa", coastal: false }, { name: "Birmania", lat: 21.913965, lon: 95.956223, area: 676578, continent: "Asia", coastal: true }, { name: "Bolivia", lat: -16.290154, lon: -63.588653, area: 1098581, continent: "Am√©rica", coastal: false }, { name: "Bosnia y Herzegovina", lat: 43.915886, lon: 17.679076, area: 51209, continent: "Europa", coastal: true }, { name: "Botsuana", lat: -22.328474, lon: 24.684866, area: 582000, continent: "√Åfrica", coastal: false }, { name: "Brasil", lat: -14.235004, lon: -51.92528, area: 8515767, continent: "Am√©rica", coastal: true }, { name: "Brun√©i", lat: 4.535277, lon: 114.727669, area: 5765, continent: "Asia", coastal: true }, { name: "Bulgaria", lat: 42.733883, lon: 25.48583, area: 110879, continent: "Europa", coastal: true }, { name: "Burkina Faso", lat: 12.238333, lon: -1.561593, area: 274200, continent: "√Åfrica", coastal: false }, { name: "Burundi", lat: -3.373056, lon: 29.918886, area: 27834, continent: "√Åfrica", coastal: false }, { name: "But√°n", lat: 27.514162, lon: 90.433601, area: 38394, continent: "Asia", coastal: false }, { name: "Cabo Verde", lat: 16.002082, lon: -24.013197, area: 4033, continent: "√Åfrica", coastal: true }, { name: "Camboya", lat: 12.565679, lon: 104.990963, area: 181035, continent: "Asia", coastal: true }, { name: "Camer√∫n", lat: 7.369722, lon: 12.354722, area: 475442, continent: "√Åfrica", coastal: true }, { name: "Canad√°", lat: 56.130366, lon: -106.346771, area: 9984670, continent: "Am√©rica", coastal: true }, { name: "Catar", lat: 25.354826, lon: 51.183884, area: 11586, continent: "Asia", coastal: true }, { name: "Chad", lat: 15.454166, lon: 18.732207, area: 1284000, continent: "√Åfrica", coastal: false }, { name: "Chile", lat: -35.675147, lon: -71.542969, area: 756102, continent: "Am√©rica", coastal: true }, { name: "China", lat: 35.86166, lon: 104.195397, area: 9706961, continent: "Asia", coastal: true }, { name: "Chipre", lat: 35.126413, lon: 33.429859, area: 9251, continent: "Asia", coastal: true }, { name: "Colombia", lat: 4.570868, lon: -74.297333, area: 1141748, continent: "Am√©rica", coastal: true }, { name: "Comoras", lat: -11.875001, lon: 43.872219, area: 2235, continent: "√Åfrica", coastal: true }, { name: "Corea del Norte", lat: 40.339852, lon: 127.510093, area: 120538, continent: "Asia", coastal: true }, { name: "Corea del Sur", lat: 35.907757, lon: 127.766922, area: 100210, continent: "Asia", coastal: true }, { name: "Costa de Marfil", lat: 7.539989, lon: -5.54708, area: 322463, continent: "√Åfrica", coastal: true }, { name: "Costa Rica", lat: 9.748917, lon: -83.753428, area: 51100, continent: "Am√©rica", coastal: true }, { name: "Croacia", lat: 45.1, lon: 15.2, area: 56594, continent: "Europa", coastal: true }, { name: "Cuba", lat: 21.521757, lon: -77.781167, area: 109884, continent: "Am√©rica", coastal: true }, { name: "Dinamarca", lat: 56.26392, lon: 9.501785, area: 43094, continent: "Europa", coastal: true }, { name: "Dominica", lat: 15.414999, lon: -61.370976, area: 751, continent: "Am√©rica", coastal: true }, { name: "Ecuador", lat: -1.831239, lon: -78.183406, area: 276841, continent: "Am√©rica", coastal: true }, { name: "Egipto", lat: 26.820553, lon: 30.802498, area: 1002450, continent: "√Åfrica", coastal: true }, { name: "El Salvador", lat: 13.794185, lon: -88.89653, area: 21041, continent: "Am√©rica", coastal: true }, { name: "Emiratos √Årabes Unidos", lat: 23.424076, lon: 53.847818, area: 83600, continent: "Asia", coastal: true }, { name: "Eritrea", lat: 15.179384, lon: 39.782334, area: 117600, continent: "√Åfrica", coastal: true }, { name: "Eslovaquia", lat: 48.669026, lon: 19.699024, area: 49037, continent: "Europa", coastal: false }, { name: "Eslovenia", lat: 46.151241, lon: 14.995463, area: 20273, continent: "Europa", coastal: true }, { name: "Espa√±a", lat: 40.463667, lon: -3.74922, area: 505992, continent: "Europa", coastal: true }, { name: "Estados Unidos", lat: 37.09024, lon: -95.712891, area: 9833520, continent: "Am√©rica", coastal: true }, { name: "Estonia", lat: 58.595272, lon: 25.013607, area: 45227, continent: "Europa", coastal: true }, { name: "Etiop√≠a", lat: 9.145, lon: 40.489673, area: 1104300, continent: "√Åfrica", coastal: false }, { name: "Filipinas", lat: 12.879721, lon: 121.774017, area: 342353, continent: "Asia", coastal: true }, { name: "Finlandia", lat: 61.92411, lon: 25.748151, area: 338424, continent: "Europa", coastal: true }, { name: "Fiyi", lat: -17.713371, lon: 178.065032, area: 18272, continent: "Ocean√≠a", coastal: true }, { name: "Francia", lat: 46.227638, lon: 2.213749, area: 640679, continent: "Europa", coastal: true }, { name: "Gab√≥n", lat: -0.803689, lon: 11.609444, area: 267667, continent: "√Åfrica", coastal: true }, { name: "Gambia", lat: 13.443182, lon: -15.310139, area: 10689, continent: "√Åfrica", coastal: true }, { name: "Georgia", lat: 42.315407, lon: 43.356892, area: 69700, continent: "Asia", coastal: true }, { name: "Ghana", lat: 7.946527, lon: -1.023194, area: 238533, continent: "√Åfrica", coastal: true }, { name: "Granada", lat: 12.1165, lon: -61.679, area: 344, continent: "Am√©rica", coastal: true }, { name: "Grecia", lat: 39.074208, lon: 21.824312, area: 131990, continent: "Europa", coastal: true }, { name: "Guatemala", lat: 15.783471, lon: -90.230759, area: 108889, continent: "Am√©rica", coastal: true }, { name: "Guinea", lat: 9.945587, lon: -9.696645, area: 245857, continent: "√Åfrica", coastal: true }, { name: "Guinea Ecuatorial", lat: 1.650801, lon: 10.267895, area: 28051, continent: "√Åfrica", coastal: true }, { name: "Guinea-Bis√°u", lat: 11.803749, lon: -15.180413, area: 36125, continent: "√Åfrica", coastal: true }, { name: "Guyana", lat: 4.860416, lon: -58.93018, area: 214969, continent: "Am√©rica", coastal: true }, { name: "Hait√≠", lat: 18.971187, lon: -72.285215, area: 27750, continent: "Am√©rica", coastal: true }, { name: "Honduras", lat: 15.199999, lon: -86.241905, area: 112492, continent: "Am√©rica", coastal: true }, { name: "Hungr√≠a", lat: 47.162494, lon: 19.503304, area: 93028, continent: "Europa", coastal: false }, { name: "India", lat: 20.593684, lon: 78.96288, area: 3287590, continent: "Asia", coastal: true }, { name: "Indonesia", lat: -0.789275, lon: 113.921327, area: 1904569, continent: "Asia", coastal: true }, { name: "Irak", lat: 33.223191, lon: 43.679291, area: 438317, continent: "Asia", coastal: true }, { name: "Ir√°n", lat: 32.427908, lon: 53.688046, area: 1648195, continent: "Asia", coastal: true }, { name: "Irlanda", lat: 53.41291, lon: -8.24389, area: 70273, continent: "Europa", coastal: true }, { name: "Islandia", lat: 64.963051, lon: -19.020835, area: 103000, continent: "Europa", coastal: true }, { name: "Islas Marshall", lat: 7.131474, lon: 171.184478, area: 181, continent: "Ocean√≠a", coastal: true }, { name: "Islas Salom√≥n", lat: -9.64571, lon: 160.156194, area: 28896, continent: "Ocean√≠a", coastal: true }, { name: "Israel", lat: 31.046051, lon: 34.851612, area: 20770, continent: "Asia", coastal: true }, { name: "Italia", lat: 41.87194, lon: 12.56738, area: 301336, continent: "Europa", coastal: true }, { name: "Jamaica", lat: 18.109581, lon: -77.297508, area: 10991, continent: "Am√©rica", coastal: true }, { name: "Jap√≥n", lat: 36.204824, lon: 138.252924, area: 377930, continent: "Asia", coastal: true }, { name: "Jordania", lat: 30.585164, lon: 36.238414, area: 89342, continent: "Asia", coastal: true }, { name: "Kazajist√°n", lat: 48.019573, lon: 66.923684, area: 2724900, continent: "Asia", coastal: false }, { name: "Kenia", lat: -0.023559, lon: 37.906193, area: 580367, continent: "√Åfrica", coastal: true }, { name: "Kirguist√°n", lat: 41.20438, lon: 74.766098, area: 199951, continent: "Asia", coastal: false }, { name: "Kiribati", lat: -3.370417, lon: -168.734039, area: 811, continent: "Ocean√≠a", coastal: true }, { name: "Kuwait", lat: 29.31166, lon: 47.481766, area: 17818, continent: "Asia", coastal: true }, { name: "Laos", lat: 19.85627, lon: 102.495496, area: 236800, continent: "Asia", coastal: false }, { name: "Lesoto", lat: -29.609988, lon: 28.233608, area: 30355, continent: "√Åfrica", coastal: false }, { name: "Letonia", lat: 56.879635, lon: 24.603189, area: 64559, continent: "Europa", coastal: true }, { name: "L√≠bano", lat: 33.854721, lon: 35.862285, area: 10452, continent: "Asia", coastal: true }, { name: "Liberia", lat: 6.428055, lon: -9.429499, area: 111369, continent: "√Åfrica", coastal: true }, { name: "Libia", lat: 26.3351, lon: 17.228331, area: 1759540, continent: "√Åfrica", coastal: true }, { name: "Liechtenstein", lat: 47.166, lon: 9.555373, area: 160, continent: "Europa", coastal: false }, { name: "Lituania", lat: 55.169438, lon: 23.881275, area: 65300, continent: "Europa", coastal: true }, { name: "Luxemburgo", lat: 49.815273, lon: 6.129583, area: 2586, continent: "Europa", coastal: false }, { name: "Macedonia del Norte", lat: 41.608635, lon: 21.745275, area: 25713, continent: "Europa", coastal: false }, { name: "Madagascar", lat: -18.766947, lon: 46.869107, area: 587041, continent: "√Åfrica", coastal: true }, { name: "Malasia", lat: 4.210484, lon: 101.975766, area: 330803, continent: "Asia", coastal: true }, { name: "Malaui", lat: -13.254308, lon: 34.301525, area: 118484, continent: "√Åfrica", coastal: false }, { name: "Maldivas", lat: 3.202778, lon: 73.22068, area: 300, continent: "Asia", coastal: true }, { name: "Mal√≠", lat: 17.570692, lon: -3.996166, area: 1240192, continent: "√Åfrica", coastal: false }, { name: "Malta", lat: 35.937496, lon: 14.375416, area: 316, continent: "Europa", coastal: true }, { name: "Marruecos", lat: 31.791702, lon: -7.09262, area: 446550, continent: "√Åfrica", coastal: true }, { name: "Mauricio", lat: -20.348404, lon: 57.552152, area: 2040, continent: "√Åfrica", coastal: true }, { name: "Mauritania", lat: 21.00789, lon: -10.940835, area: 1030700, continent: "√Åfrica", coastal: true }, { name: "M√©xico", lat: 23.634501, lon: -102.552784, area: 1964375, continent: "Am√©rica", coastal: true }, { name: "Micronesia", lat: 7.425554, lon: 150.550812, area: 702, continent: "Ocean√≠a", coastal: true }, { name: "Moldavia", lat: 47.411631, lon: 28.369885, area: 33846, continent: "Europa", coastal: false }, { name: "M√≥naco", lat: 43.750298, lon: 7.412841, area: 2.02, continent: "Europa", coastal: true }, { name: "Mongolia", lat: 46.862496, lon: 103.846656, area: 1564110, continent: "Asia", coastal: false }, { name: "Montenegro", lat: 42.708678, lon: 19.37439, area: 13812, continent: "Europa", coastal: true }, { name: "Mozambique", lat: -18.665695, lon: 35.529562, area: 801590, continent: "√Åfrica", coastal: true }, { name: "Namibia", lat: -22.95764, lon: 18.49041, area: 825615, continent: "√Åfrica", coastal: true }, { name: "Nauru", lat: -0.522778, lon: 166.931503, area: 21, continent: "Ocean√≠a", coastal: true }, { name: "Nepal", lat: 28.394857, lon: 84.124008, area: 147181, continent: "Asia", coastal: false }, { name: "Nicaragua", lat: 12.865416, lon: -85.207229, area: 130373, continent: "Am√©rica", coastal: true }, { name: "N√≠ger", lat: 17.607789, lon: 8.081666, area: 1267000, continent: "√Åfrica", coastal: false }, { name: "Nigeria", lat: 9.081999, lon: 8.675277, area: 923768, continent: "√Åfrica", coastal: true }, { name: "Noruega", lat: 60.472024, lon: 8.468946, area: 323802, continent: "Europa", coastal: true }, { name: "Nueva Zelanda", lat: -40.900557, lon: 174.885971, area: 270467, continent: "Ocean√≠a", coastal: true }, { name: "Om√°n", lat: 21.512583, lon: 55.923255, area: 309500, continent: "Asia", coastal: true }, { name: "Pa√≠ses Bajos", lat: 52.132633, lon: 5.291266, area: 41850, continent: "Europa", coastal: true }, { name: "Pakist√°n", lat: 30.375321, lon: 69.345116, area: 881912, continent: "Asia", coastal: true }, { name: "Palaos", lat: 7.51498, lon: 134.58252, area: 459, continent: "Ocean√≠a", coastal: true }, { name: "Panam√°", lat: 8.537981, lon: -80.782127, area: 75417, continent: "Am√©rica", coastal: true }, { name: "Pap√∫a Nueva Guinea", lat: -6.314993, lon: 143.95555, area: 462840, continent: "Ocean√≠a", coastal: true }, { name: "Paraguay", lat: -23.442503, lon: -58.443832, area: 406752, continent: "Am√©rica", coastal: false }, { name: "Per√∫", lat: -9.189967, lon: -75.015152, area: 1285216, continent: "Am√©rica", coastal: true }, { name: "Polonia", lat: 51.919438, lon: 19.145136, area: 312679, continent: "Europa", coastal: true }, { name: "Portugal", lat: 39.399872, lon: -8.224454, area: 92090, continent: "Europa", coastal: true }, { name: "Reino Unido", lat: 55.378051, lon: -3.435973, area: 242900, continent: "Europa", coastal: true }, { name: "Rep√∫blica Centroafricana", lat: 6.611111, lon: 20.939444, area: 622984, continent: "√Åfrica", coastal: false }, { name: "Rep√∫blica Checa", lat: 49.817492, lon: 15.472962, area: 78865, continent: "Europa", coastal: false }, { name: "Rep√∫blica del Congo", lat: -0.228021, lon: 15.827659, area: 342000, continent: "√Åfrica", coastal: true }, { name: "Rep√∫blica Democr√°tica del Congo", lat: -4.038333, lon: 21.758664, area: 2344858, continent: "√Åfrica", coastal: true }, { name: "Rep√∫blica Dominicana", lat: 18.735693, lon: -70.162651, area: 48671, continent: "Am√©rica", coastal: true }, { name: "Ruanda", lat: -1.940278, lon: 29.873888, area: 26338, continent: "√Åfrica", coastal: false }, { name: "Rumania", lat: 45.943161, lon: 24.96676, area: 238391, continent: "Europa", coastal: true }, { name: "Rusia", lat: 61.52401, lon: 105.318756, area: 17098242, continent: "Europa", coastal: true }, { name: "Samoa", lat: -13.759029, lon: -172.104629, area: 2842, continent: "Ocean√≠a", coastal: true }, { name: "San Crist√≥bal y Nieves", lat: 17.357822, lon: -62.782998, area: 261, continent: "Am√©rica", coastal: true }, { name: "San Marino", lat: 43.94236, lon: 12.457777, area: 61, continent: "Europa", coastal: false }, { name: "San Vicente y las Granadinas", lat: 12.984305, lon: -61.287228, area: 389, continent: "Am√©rica", coastal: true }, { name: "Santa Luc√≠a", lat: 13.909444, lon: -60.978893, area: 616, continent: "Am√©rica", coastal: true }, { name: "Santo Tom√© y Pr√≠ncipe", lat: 0.18636, lon: 6.613081, area: 964, continent: "√Åfrica", coastal: true }, { name: "Senegal", lat: 14.497401, lon: -14.452362, area: 196722, continent: "√Åfrica", coastal: true }, { name: "Serbia", lat: 44.016521, lon: 21.005859, area: 88361, continent: "Europa", coastal: false }, { name: "Seychelles", lat: -4.679574, lon: 55.491977, area: 452, continent: "√Åfrica", coastal: true }, { name: "Sierra Leona", lat: 8.460555, lon: -11.779889, area: 71740, continent: "√Åfrica", coastal: true }, { name: "Singapur", lat: 1.352083, lon: 103.819836, area: 710, continent: "Asia", coastal: true }, { name: "Siria", lat: 34.802075, lon: 38.996815, area: 185180, continent: "Asia", coastal: true }, { name: "Somalia", lat: 5.152149, lon: 46.199616, area: 637657, continent: "√Åfrica", coastal: true }, { name: "Sri Lanka", lat: 7.873054, lon: 80.771797, area: 65610, continent: "Asia", coastal: true }, { name: "Suazilandia", lat: -26.522503, lon: 31.465866, area: 17364, continent: "√Åfrica", coastal: false }, { name: "Sud√°frica", lat: -30.559482, lon: 22.937506, area: 1221037, continent: "√Åfrica", coastal: true }, { name: "Sud√°n", lat: 12.862807, lon: 30.217636, area: 1861484, continent: "√Åfrica", coastal: true }, { name: "Sud√°n del Sur", lat: 6.876992, lon: 31.306979, area: 619745, continent: "√Åfrica", coastal: false }, { name: "Suecia", lat: 60.128161, lon: 18.643501, area: 450295, continent: "Europa", coastal: true }, { name: "Suiza", lat: 46.818188, lon: 8.227512, area: 41284, continent: "Europa", coastal: false }, { name: "Surinam", lat: 3.919305, lon: -56.027783, area: 163820, continent: "Am√©rica", coastal: true }, { name: "Tailandia", lat: 15.870032, lon: 100.992541, area: 513120, continent: "Asia", coastal: true }, { name: "Tanzania", lat: -6.369028, lon: 34.888822, area: 945087, continent: "√Åfrica", coastal: true }, { name: "Tayikist√°n", lat: 38.861034, lon: 71.276093, area: 143100, continent: "Asia", coastal: false }, { name: "Timor Oriental", lat: -8.874217, lon: 125.727539, area: 14874, continent: "Asia", coastal: true }, { name: "Togo", lat: 8.619543, lon: 0.824782, area: 56785, continent: "√Åfrica", coastal: true }, { name: "Tonga", lat: -21.178986, lon: -175.198242, area: 747, continent: "Ocean√≠a", coastal: true }, { name: "Trinidad y Tobago", lat: 10.691803, lon: -61.222523, area: 5130, continent: "Am√©rica", coastal: true }, { name: "T√∫nez", lat: 33.886917, lon: 9.537499, area: 163610, continent: "√Åfrica", coastal: true }, { name: "Turkmenist√°n", lat: 38.969719, lon: 59.556278, area: 488100, continent: "Asia", coastal: false }, { name: "Turqu√≠a", lat: 38.963745, lon: 35.243322, area: 783562, continent: "Asia", coastal: true }, { name: "Tuvalu", lat: -7.109535, lon: 177.64933, area: 26, continent: "Ocean√≠a", coastal: true }, { name: "Ucrania", lat: 48.379433, lon: 31.16558, area: 603550, continent: "Europa", coastal: true }, { name: "Uganda", lat: 1.373333, lon: 32.290275, area: 241551, continent: "√Åfrica", coastal: false }, { name: "Uruguay", lat: -32.522779, lon: -55.765835, area: 176215, continent: "Am√©rica", coastal: true }, { name: "Uzbekist√°n", lat: 41.377491, lon: 64.585262, area: 447400, continent: "Asia", coastal: false }, { name: "Vanuatu", lat: -15.376706, lon: 166.959158, area: 12189, continent: "Ocean√≠a", coastal: true }, { name: "Venezuela", lat: 6.42375, lon: -66.58973, area: 916445, continent: "Am√©rica", coastal: true }, { name: "Vietnam", lat: 14.058324, lon: 108.277199, area: 331212, continent: "Asia", coastal: true }, { name: "Yemen", lat: 15.552727, lon: 48.516388, area: 527968, continent: "Asia", coastal: true }, { name: "Yibuti", lat: 11.825138, lon: 42.590275, area: 23200, continent: "√Åfrica", coastal: true }, { name: "Zambia", lat: -13.133897, lon: 27.849332, area: 752612, continent: "√Åfrica", coastal: false }, { name: "Zimbabue", lat: -19.015438, lon: 29.154857, area: 390757, continent: "√Åfrica", coastal: false }
            ];

            const richDataMap = new Map(richData.map(item => [item.name, item]));
            
            allCountriesData.forEach(country => {
                const richInfo = richDataMap.get(country.name);
                gameDatabase.push({
                    ...country,
                    Monstruos: richInfo?.Monstruos || [],
                    Tesoros: richInfo?.Tesoros || [],
                    Preguntas: richInfo?.Preguntas || [],
                    Respuesta1: richInfo?.Respuesta1 || [],
                    Respuesta2: richInfo?.Respuesta2 || [],
                    Respuesta3: richInfo?.Respuesta3 || [],
                    Pistas: richInfo?.Pistas || [],
                    Excusas: richInfo?.Excusas || ["la mala suerte te impide marcharte."]
                });
            });
            generatePlayerNameInputs();
        }

        startGameBtn.addEventListener('click', () => {
            startGameBtn.disabled = true;
            startGameBtn.textContent = 'Creando mundo...';
            const nameInputs = document.querySelectorAll('.player-name-input');
            players = [];
            nameInputs.forEach((input, index) => {
                players.push({
                    name: input.value || `Aventurero ${index + 1}`,
                    currentCountry: 'Espa√±a',
                    hp: 20,
                });
            });

            if (players.length > 0) {
                setupNewGame();
                setupSection.classList.add('hidden');
                gameSection.classList.remove('hidden');
                currentPlayerIndex = 0;
                updateUI();
            }
            startGameBtn.disabled = false;
            startGameBtn.textContent = 'üåç ¬°Comenzar Aventura!';
        });

        restartGameBtn.addEventListener('click', () => {
            gameSection.classList.add('hidden');
            setupSection.classList.remove('hidden');
            mainTitle.textContent = 'Configuraci√≥n de la Partida';
            subtitle.textContent = '¬øQui√©nes se unen a la aventura?';
            gmPanel.classList.add('hidden');
            gmToggleBtn.textContent = 'üëÅÔ∏è Ver Secretos';
        });

        gmToggleBtn.addEventListener('click', () => {
            gmPanel.classList.toggle('hidden');
            gmToggleBtn.textContent = gmPanel.classList.contains('hidden') 
                ? 'üëÅÔ∏è Ver Secretos' 
                : 'üôà Ocultar Secretos';
        });

        playerCountInput.addEventListener('change', generatePlayerNameInputs);

        window.onload = async () => {
            await loadGameData();
            treasureTracker.addEventListener('click', showCollectedTreasures);
        };

        function showCollectedTreasures() {
            if (document.getElementById('treasure-modal')) return; // Evita abrir m√∫ltiples modales

            if (gameState.treasuresCollected.length === 0) {
                const originalText = treasureTracker.textContent;
                treasureTracker.textContent = "¬°A√∫n no has encontrado tesoros!";
                setTimeout(() => { treasureTracker.textContent = originalText; }, 2000);
                return;
            }

            let treasuresHtml = '<ul class="space-y-2">';
            gameState.treasuresCollected.forEach(t => {
                treasuresHtml += `<li class="text-slate-800"><strong class="text-amber-600">${t.name}</strong> (encontrado en ${t.country})</li>`;
            });
            treasuresHtml += '</ul>';

            const modalHtml = `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" id="treasure-modal">
                    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
                        <h2 class="text-2xl font-bold text-sky-700 mb-4 text-center">Tesoros Encontrados</h2>
                        ${treasuresHtml}
                        <div class="mt-6 text-center">
                            <button id="close-treasure-modal" class="bg-sky-500 text-white font-bold py-2 px-6 rounded-full">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('close-treasure-modal').addEventListener('click', () => {
                document.getElementById('treasure-modal').remove();
            });
        }
        
        function startCombat(countryName) {
            const monsterInfo = gameMasterData.monsters[countryName];
            gameState.currentCombat = {
                 country: countryName,
                 monster: { ...monsterInfo },
                 turn: 'player', 
                 stuckPlayers: [],
            };
             renderCombatView();
        }

        function renderCombatView() {
            const combat = gameState.currentCombat;
            const player = players[currentPlayerIndex];
            const isPlayerTurn = combat.turn === 'player';

            let html = `<div class="text-center">
                <h2 class="text-2xl font-bold text-red-700">¬°Combate en ${combat.country}!</h2>
                <p class="text-xl my-2">Te enfrentas a: <strong>${combat.monster.name}</strong> (‚ù§Ô∏è ${combat.monster.hp})</p>
                <div id="combat-log" class="my-2 p-2 bg-gray-100 rounded-lg min-h-[50px]"></div>
            `;
            
            if (combat.stuckPlayers.includes(player.name)) {
                html += `<p class="text-yellow-600 font-bold">¬°No pudiste huir! Est√°s atascado este turno.</p>`;
                setTimeout(() => {
                    combat.stuckPlayers = combat.stuckPlayers.filter(p => p !== player.name);
                    nextTurn();
                }, 2000);
            } else if (isPlayerTurn) {
                html += `
                    <p class="font-bold my-2">Turno de ${player.name}. Introduce tu tirada (D20):</p>
                    <input type="number" id="combat-roll-input" class="p-2 rounded-lg border-2" min="1" max="20">
                    <button id="submit-roll-btn" class="btn-action bg-red-500 text-white font-bold py-2 px-4 rounded-lg ml-2">Atacar</button>
                    <button id="flee-btn" class="btn-action bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg ml-2">Huir (D4)</button>
                `;
            } else { // Turno del monstruo
                html += `
                    <p class="font-bold my-2">Turno del Game Master. Introduce la tirada de ${combat.monster.name} (D20):</p>
                    <input type="number" id="combat-roll-input" class="p-2 rounded-lg border-2" min="1" max="20">
                    <button id="submit-roll-btn" class="btn-action bg-gray-700 text-white font-bold py-2 px-4 rounded-lg ml-2">Atacar</button>
                `;
            }
            html += `</div>`;
            renderView(html);
            
            if (document.getElementById('submit-roll-btn')) {
                document.getElementById('submit-roll-btn').addEventListener('click', handleCombatRoll);
                if (document.getElementById('flee-btn')) {
                    document.getElementById('flee-btn').addEventListener('click', handleFleeAttempt);
                }
                document.getElementById('combat-roll-input').focus();
            }
        }
        
        function handleFleeAttempt() {
            const roll = getRandomElement([1, 2, 3, 4]);
            const log = document.getElementById('combat-log');
            if(roll >= 3) {
                log.innerHTML = `¬°Tirada de ${roll}! Has conseguido huir.`;
                gameState.currentCombat = null;
                setTimeout(nextTurn, 2000);
            } else {
                log.innerHTML = `¬°Tirada de ${roll}! El monstruo te bloquea el paso.`;
                gameState.currentCombat.stuckPlayers.push(players[currentPlayerIndex].name);
                setTimeout(nextTurn, 2000);
            }
        }

        function handleCombatRoll() {
            const combat = gameState.currentCombat;
            const player = players[currentPlayerIndex];
            const log = document.getElementById('combat-log');
            const rollInput = document.getElementById('combat-roll-input');
            const roll = parseInt(rollInput.value, 10);
            
            if(isNaN(roll)) { log.textContent = "Introduce un valor v√°lido."; return; }

            if(combat.turn === 'player') {
                combat.monster.hp -= roll;
                log.innerHTML = `<p>${player.name} ataca y hace <strong>${roll}</strong> de da√±o.</p>`;
                if (combat.monster.hp <= 0) {
                    log.innerHTML += `<p>¬°Has derrotado a ${combat.monster.name}!</p>`;
                    gameMasterData.monsters[combat.country].defeated = true;
                    gameState.currentCombat = null;
                    setTimeout(nextTurn, 2000);
                } else {
                    combat.turn = 'monster';
                    setTimeout(renderCombatView, 1500);
                }
            } else { // Turno del monstruo
                player.hp -= roll;
                log.innerHTML = `<p>${combat.monster.name} contraataca y hace <strong>${roll}</strong> de da√±o.</p>`;
                if (player.hp <= 0) {
                    log.innerHTML += `<p>¬°Oh no! ¬°${player.name} ha sido derrotado!</p>`;
                }
                combat.turn = 'player';
                setTimeout(nextTurn, 2000);
            }
            updateUI();
        }

        function offerPortTravel(countryName) {
            renderView(`
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-blue-700">¬°Has llegado a un puerto en ${countryName}!</h2>
                    <p class="my-4">Puedes tomar un barco para viajar a cualquier pa√≠s del mundo.</p>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="sail-btn" class="btn-action bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">S√≠, ¬°quiero zarpar!</button>
                        <button id="stay-btn" class="btn-action bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">No, prefiero quedarme</button>
                    </div>
                </div>
            `);
            document.getElementById('stay-btn').addEventListener('click', nextTurn);
            document.getElementById('sail-btn').addEventListener('click', () => {
                let options = gameDatabase.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                renderView(`
                    <div class="text-center">
                        <h2 class="text-xl font-bold">Elige tu destino:</h2>
                        <select id="destination-select" class="w-full p-2 mt-4 rounded-lg border-2">${options}</select>
                        <button id="confirm-dest-btn" class="btn-action mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Confirmar Destino</button>
                    </div>`);
                
                document.getElementById('confirm-dest-btn').addEventListener('click', () => {
                    const destination = document.getElementById('destination-select').value;
                    const startCountry = gameDatabase.find(c => c.name === countryName);
                    const endCountry = gameDatabase.find(c => c.name === destination);
                    const distance = getDistance(startCountry.lat, startCountry.lon, endCountry.lat, endCountry.lon);
                    const cost = Math.ceil(distance / 500);

                    renderView(`
                        <div class="text-center">
                             <p>Viajar a <strong>${destination}</strong> costar√° <strong>${cost}</strong> puntos de dado.</p>
                             <p class="mt-4">¬øConfirmas el viaje?</p>
                             <div class="flex justify-center gap-4 mt-6">
                                 <button id="confirm-sail-btn" class="btn-action bg-green-500 text-white font-bold py-2 px-4 rounded-lg">¬°S√≠, a la mar!</button>
                                 <button id="cancel-sail-btn" class="btn-action bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Mejor no</button>
                             </div>
                        </div>`);
                    document.getElementById('cancel-sail-btn').addEventListener('click', nextTurn);
                    document.getElementById('confirm-sail-btn').addEventListener('click', () => {
                        gameState.currentSeaVoyage = {
                            playerIndex: currentPlayerIndex,
                            destination,
                            cost,
                            progress: 0,
                        };
                        nextTurn();
                    });
                });
            });
        }
        
        function renderSeaVoyageView() {
            const voyage = gameState.currentSeaVoyage;
            renderView(`
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-blue-700">üåä ¬°Viaje por mar! üåä</h2>
                    <p class="my-2">Destino: <strong>${voyage.destination}</strong></p>
                    <p>Progreso del viaje: <strong>${voyage.progress} / ${voyage.cost}</strong> puntos</p>
                    <button id="roll-sail-btn" class="btn-action mt-6 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg">Tirar dado de viaje (D12)</button>
                    <div id="sail-log" class="mt-4 font-semibold"></div>
                </div>`);
            
            document.getElementById('roll-sail-btn').addEventListener('click', () => {
                document.getElementById('roll-sail-btn').disabled = true;
                const roll = getRandomElement([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);
                voyage.progress += roll;
                document.getElementById('sail-log').textContent = `¬°Has sacado un ${roll}!`;

                if (voyage.progress >= voyage.cost) {
                    players[currentPlayerIndex].currentCountry = voyage.destination;
                    gameState.currentSeaVoyage = null;
                    document.getElementById('sail-log').innerHTML += `<p class="text-green-600 mt-2">¬°Tierra a la vista! Has llegado a ${players[currentPlayerIndex].currentCountry}.</p>`;
                    setTimeout(() => {
                        updateUI();
                        checkCountryForEvent(players[currentPlayerIndex].currentCountry);
                    }, 2500);
                } else {
                    setTimeout(nextTurn, 2000);
                }
            });
        }

        function startTreasureQuest(countryName) {
            const treasureInfo = gameMasterData.treasures[countryName];
            const onCorrect = () => {
                gameMasterData.treasures[countryName].found = true;
                gameState.treasuresCollected.push({ name: treasureInfo.name, country: countryName });
                updateUI();
                renderView(`<div class="text-center text-2xl font-bold text-amber-600">¬°Felicidades! ¬°Has conseguido el tesoro: ${treasureInfo.name}!</div>`);
                setTimeout(nextTurn, 2500);
            };
            
            startTrivia(countryName, false, onCorrect);
        }
        
        function generateTreasureClue(currentCountryName) {
            const continent = gameDatabase.find(c => c.name === currentCountryName)?.continent;
            if (!continent) { nextTurn(); return; }

            const treasureEntry = Object.entries(gameMasterData.treasures).find(([_,v]) => v.continent === continent);
            if (treasureEntry && !treasureEntry[1].found) {
                const treasureCountryName = treasureEntry[0];
                const treasureCountryData = gameDatabase.find(c => c.name === treasureCountryName);
                
                if (!gameState.triviaState[treasureCountryName]) {
                    gameState.triviaState[treasureCountryName] = { usedClues: [] };
                }

                const availableClues = treasureCountryData.Pistas.map((c, i) => i)
                    .filter(i => !(gameState.triviaState[treasureCountryName].usedClues || []).includes(i));
                
                if (availableClues.length === 0) {
                     renderView(`<div class="text-center"><p>¬°No quedan m√°s pistas para este tesoro!</p><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Continuar</button></div>`);
                     document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
                     return;
                }
                
                const clueIndex = getRandomElement(availableClues);
                if (!gameState.triviaState[treasureCountryName].usedClues) {
                    gameState.triviaState[treasureCountryName].usedClues = [];
                }
                gameState.triviaState[treasureCountryName].usedClues.push(clueIndex);
                const clue = treasureCountryData.Pistas[clueIndex] || "El tesoro est√° bien escondido.";

                renderView(`<div class="text-center"><p class="font-bold">Pista sobre el tesoro de ${continent}:</p><p>"${clue}"</p><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Continuar</button></div>`);
                document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
            } else {
                renderView(`<div class="text-center"><p>¬°Ya ten√©is el tesoro de este continente!</p><button class="next-turn-btn mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Continuar</button></div>`);
                document.querySelector('.next-turn-btn').addEventListener('click', nextTurn);
            }
        }
    </script>
</body>
</html>
